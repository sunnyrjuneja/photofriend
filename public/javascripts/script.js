// Generated by CoffeeScript 1.6.2
$(function() {
  var ajaxPhotos, createdAt, hasNextPage, iosocket, loadItems, loadOnScroll;

  iosocket = io.connect();
  iosocket.on('new image', function(photo) {
    return $('#photos').prepend('<div class="img-crop"><img src="' + photo.url + '"></div>');
  });
  filepicker.setKey('AvovSWfJJQCaOl9IhtTofz');
  $('#fpicker').click(function() {
    filepicker.pickAndStore({
      mimetype: 'image/*',
      maxSize: 2097152
    }, {}, function(fpfile) {
      return iosocket.emit('upload', fpfile[0]);
    }, function(fpfile) {
      return console.log("ERROR");
    });
    return false;
  });
  hasNextPage = true;
  createdAt = "";
  $(document).ready(function() {
    $(window).bind('scroll', loadOnScroll);
    return ajaxPhotos();
  });
  loadOnScroll = function() {
    if ($(window).scrollTop() > $(document).height() - ($(window).height() * 2)) {
      $(window).unbind();
      return loadItems();
    }
  };
  loadItems = function() {
    if (!hasNextPage) {
      return false;
    } else {
      return ajaxPhotos();
    }
  };
  return ajaxPhotos = function() {
    return $.ajax({
      url: 'list?createdAt=' + createdAt,
      success: function(data, status, jqXHR) {
        var dataLength, photo, _i, _len;

        for (_i = 0, _len = data.length; _i < _len; _i++) {
          photo = data[_i];
          $("#photos").append('<div class="img-crop"><img src="' + photo.url + '"></div>');
        }
        dataLength = data.length;
        if (dataLength < 10) {
          hasNextPage = false;
        }
        return createdAt = data[dataLength - 1].createdAt;
      }
    });
  };
});
