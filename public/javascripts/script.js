// Generated by CoffeeScript 1.6.1
(function() {

  $(function() {
    var iosocket, send_message;
    iosocket = io.connect();
    iosocket.on('connect', function() {
      return iosocket.on('new image', function(name) {
        return $('#images').prepend("<div class='img-crop'><img src='/uploads/" + name + "'></div>");
      });
    });
    send_message = function(message) {
      $('#progress-bar').hide();
      $('#message strong').text(message);
      return $('#message').show();
    };
    $('#user-file-text, #user-file-button').click(function() {
      return $('#user-file').click();
    });
    $('#user-file').change(function(e) {
      var index, val;
      val = $(e.target).val();
      index = val.indexOf('\\') >= 0 ? val.lastIndexOf('\\') : val.lastIndexOf('/');
      if (index >= 0) {
        val = val.substring(index + 1);
      }
      $('#user-file-text').val(val);
      return $('input[type="submit"]').show();
    });
    return $('input[type="submit"]').on('click', function(evt) {
      var file, formData, xhr;
      evt.preventDefault();
      $('#progress-bar').show();
      formData = new FormData;
      file = $('#user-file')[0].files[0];
      formData.append('image', file);
      xhr = new XMLHttpRequest();
      xhr.open('post', '/', true);
      xhr.upload.onprogress = function(e) {
        var percentage;
        if (e.lengthComputable) {
          percentage = (e.loaded / e.total) * 100;
          return $('#progress-bar .bar').css('width', percentage + '%');
        }
      };
      xhr.onerror = function(e) {
        return send_message('An error occured while uploading your image. Make sure your image is no larger than 2 mb.');
      };
      xhr.onload = function() {
        if (this.status !== 200) {
          return send_message('An error occured while uploading your image. Make sure your image is no larger than 2 mb.');
        } else {
          return send_message(this.statusText);
        }
      };
      xhr.send(formData);
      this.form.reset();
      return $('input[type="submit"]').hide();
    });
  });

}).call(this);
